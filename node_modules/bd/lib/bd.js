var 
  dummy

, hotplate =  require('hotplate')
, path = require('path')

, declare = require( 'simpledeclare' )

, JsonRestStore = require('jsonreststores')
, SimpleSchema = require('simpleschema')
, hotCoreJsonRestStores = hotplate.require('hotCoreJsonRestStores')
, hotCoreMultiHome = hotplate.require('hotCoreMultiHome')

;

app = hotplate.app;

exports.hotHooks = hooks = {}


hotplate.hotEvents.on('stores', 'bd', hotplate.cachable( function( done ){

  var stores = {};

  var MultiHomePermsMixin = hotCoreMultiHome.MultiHomeBasicPermissionsMixin;
  var PrivateUserDataMixin = hotCoreJsonRestStores.PrivateUserDataPermissionsMixin;

  hotCoreJsonRestStores.get( function( err, s ){
    if( err ){
      done( err );
    } else {


      // Mixin the extra hotplate-specific and driver-specific attributes  to
      // the generic Store/Schema
      var HotStore = s.HotStore;
      var HotSchema = s.HotSchema;
    
      stores.WorkspacesCategories = declare( [ HotStore, MultiHomePermsMixin ], {
    
        // COMMON
        schema: new HotSchema({
          workspaceId  : { type: 'id' },
          id           : { type: 'id' },
    
          name         : { type: 'string', notEmpty: true, trim: 50 },
        }),
    
        // COMMON
        searchSchema: new HotSchema({
          id         : { type: 'id' },
          workspaceId: { type: 'id' },
          name       : { type: 'string', searchable: true, sortable: true, notEmpty: true, trim: 50 },
        }),
    
        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,
    
        storeName:  'WorkspacesCategories',
        paramIds: [ 'workspaceId', 'id' ],
          
        publicURL: '/config/workspaces/:workspaceId/categories/',
        configStore: { workspaceId: true },
  
        checkPermissionsDeletee: function checkPermissionsGetQuery( params, body, options, doc, fullDoc, cb ){
          var self = this;
          var args = arguments;
          setTimeout( function(){
            cb( null, false );
          }, 2000 );
        },

        positionField: 'position', 
 
        // queryFilterType: '$or',
      });
    
      stores.UsersCategories = declare( [ HotStore, MultiHomePermsMixin, PrivateUserDataMixin ], {
    
        // COMMON
        schema: new HotSchema({
          userId       : { type: 'id' },
          id           : { type: 'id' },
    
          name         : { type: 'string', notEmpty: true, trim: 50 },
        }),
    
        // COMMON
        searchSchema: new HotSchema({
          id         : { type: 'id' },
          userId     : { type: 'id' },
          name       : { type: 'string', searchable: true, sortable: true, notEmpty: true, trim: 50 },
        }),
    
        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,
    
        storeName:  'UsersCategories',
        paramIds: [ 'userId', 'id' ],
          
        publicURL: '/config/users/:userId/categories/',
        configStore: { userId: true },
    
      });
    
      stores.WorkspacesUsersCategories = declare( [ HotStore, MultiHomePermsMixin, PrivateUserDataMixin ], {
    
        // COMMON
        schema: new HotSchema({
          workspaceId  : { type: 'id' },
          userId       : { type: 'id' },
          id           : { type: 'id' },
    
          name         : { type: 'string', notEmpty: true, trim: 50 },
        }),
    
        // COMMON
        searchSchema: new HotSchema({
          id         : { type: 'id' },
          userId     : { type: 'id' },
          workspaceId: { type: 'id' },
          name       : { type: 'string', filterType: { type: 'startWith' }, sortable: true, notEmpty: true, trim: 50 },

          nameCont   : { type: 'string', filterType: { type: 'contains', field: 'name', condition: 'or' } },

        }),
    
        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,
    
        storeName:  'WorkspacesUsersCategories',
        paramIds: [ 'workspaceId', 'userId', 'id' ],
          
        publicURL: '/config/workspaces/:workspaceId/users/:userId/categories/',
        configStore: { userId: true, workspaceId: true },
    
        indexStyle: 'permute',

        checkPermissionsGetQuery: function checkPermissionsGetQuery( params, body, options, cb ){
          var self = this;
          var args = arguments;
          setTimeout( function(){
            self.inheritedAsync( checkPermissionsGetQuery, args, function( err, res ){
              cb( null, false );
            });
          }, 200 );
        },

      });
    
    
    
      /* ****************************************************************** */
      /* ****************************************************************** */
      /* ****************************************************************** */
    
      stores.UsersConfig = declare( [ HotStore, MultiHomePermsMixin, PrivateUserDataMixin ], {
    
        // COMMON
        schema: new HotSchema({
          userId      :  { type: 'id', required: true },
          email       :  { type: 'string', required: true, default: "youremail@example.com", notEmpty: true, sharedValidator: 'email', trim: 70, min: 4 },
          userCategory:  { type: 'id', required: false, notEmpty: false },
          surname     :  { type: 'string', required: true, default: "Your surname", notEmpty: true, trim: 10 },
          name        :  { type: 'string', required: true, default: "Your name", notEmpty: true, trim: 50 },
        },

    
        {
          validator: function( object, originalObject, castObject, options, cb ){

            var errors = [];
            if( object.name == 'Tony' ){
              // cb( new Error("NO, TONY NO!" ) );
              errors.push( { field: 'name', message: 'NO! TONY NO!' } );
            }
            cb( null, errors );
          },
    
        } ),

        // COMMON
        searchSchema: new HotSchema({
          userId    : { type: 'id' },
    
          email     : { type: 'string', trim: 70, min: 4 },
          surname   : { type: 'string' },
          name      : { type: 'string' },
        }),
    
        paramIds :  [ 'userId' ],
    
        handlePut: true,
        handleGet: true,
    
        storeName:  'UsersConfig',
    
        publicURL: '/config/users/',
        configStore: { userId: true },
    
      });
    
    
      stores.WorkspacesConfig = declare( [ HotStore, MultiHomePermsMixin ], {
    
        schema: new HotSchema({
          workspaceId : { type: 'id' },

          longName    : { type: 'string', required: true, default: "Workspace's long name", notEmpty: true, trim: 35 },
          tag         : { type: 'string', required: true, default: "Workspace's tag line",  notEmpty: true, notEmpty: true, trim: 70 },
        }),
    
        searchSchema: new HotSchema({
          workspaceId : { type: 'id' },
          longName    : { type: 'string' },
          tag         : { type: 'string' },
        }),
    
        storeName:  'WorkspacesConfig',
        paramIds: [ 'workspaceId' ],
    
        handlePut: true,
        handleGet: true,
    
        publicURL: '/config/workspaces/',
        configStore: { workspaceId: true },
    
    
        checkPermissionsGet: function(  params, body, options, doc, fullDoc, cb ){
          cb( null, true );
        },
    
        checkPermissionsPutExisting: function( params, body, options, doc, fullDoc, cb ) {
          
          if( ! this._req.session.loggedIn ){
            cb( null, false );
          } else {
            cb( null, true );
          }
    
        },
    
        // Nobody can create new records -- they need to exist beforehand
        checkPermissionsPutNew: function( params, body, options, cb){
          cb( null, false );
        },
        
      });
    
    
      stores.WorkspacesUsersConfig = declare( [ HotStore, MultiHomePermsMixin, PrivateUserDataMixin ], {
    
        schema: new HotSchema({
          workspaceId   : { type: 'id' },
          userId        : { type: 'id' },

          localEmail    : { type: 'string', required: true, default: 'youremail@example.com', notEmpty: true, sharedValidator: 'email', trim: 35 },
        }),
    
        searchSchema: new HotSchema({
          workspaceId   : { type: 'id' },
          userId        : { type: 'id' },
    
          localEmail : { type: 'string'},
        }),
    
        storeName: 'WorkspacesUsersConfig',
        paramIds: [ 'workspaceId', 'userId' ],
    
        handlePut: true,
        handleGet: true,
    
        publicURL: '/config/workspaces/:workspaceId/users/',
        configStore: { workspaceId: true, userId: true },
    
      } );
    
      stores.NonConfig = declare( [ HotStore, MultiHomePermsMixin, PrivateUserDataMixin ],  {
    
        // COMMON
        schema: new HotSchema({
          workspaceId  : { type: 'id' },
          userId       : { type: 'id' },
          id           : { type: 'id' },
    
          name         : { type: 'string', required: true, notEmpty: true, trim: 50 },
        }),
    
        // COMMON
        searchSchema: new HotSchema({
          id         : { type: 'id' },
          userId     : { type: 'id' },
          workspaceId: { type: 'id' },
          name       : { type: 'string', sortable: true, notEmpty: true, trim: 50 },
        }),
    
        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,
    
        storeName:  'NonConfig',
        paramIds: [ 'workspaceId', 'userId', 'id' ],
          
        publicURL: '/nonConfig/workspaces/:workspaceId/users/:userId/nonConfig/',
    
      });

    }
  }); 
  
  
  done( null, [ stores.WorkspacesCategories, stores.UsersCategories, stores.WorkspacesUsersCategories, stores.UsersConfig, stores.WorkspacesConfig, stores.WorkspacesUsersConfig, stores.NonConfig ] );

} ))


// Simply activate path to client files
hotplate.hotEvents.on( 'clientPath', 'bd', function( done ){
  done( null, path.join(__dirname, '../client') );
} )

// Define which paths within clientPath will need to be rendered, and with which options
hotplate.hotEvents.on( 'clientPathRender', 'bd', function( done ){
  done( null, [ 
    {
      'templates/BookingDojo.jade': { name: 'Tony' },
      'templates/AnotherBookingDojo.jade': {},
    }
  ] );
} )



hotplate.hotEvents.on( 'dojoModulesPerPage', 'bd', function( req, pageName, done ){

  switch( pageName ){

    case 'hotDojoAppContainer/container':
      done( null, [ 'bdMain' ] );
    break;

    default:
      done( null, [ ] );
    break;
  }

});


hotplate.hotEvents.on( 'pageElements', 'bd', function( done ){
    done( null, { titleWords: [ "Booking Dojo" ] } );
})

hotplate.hotEvents.on( 'pageElementsPerPage', 'bd', function( req, pageName, done ){

  switch(pageName){

    case 'hotDojoAppContainer/container':

      // Sending the page out
      done( null, {
        csses: ['bdMain.css' ],
        titleWords: [ "Application" ],
      });

    break;

   default:
      done( null, {} );
    break;
  }
});



