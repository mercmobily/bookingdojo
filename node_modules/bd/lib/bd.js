var 
  dummy

, hotplate =  require('hotplate')
, path = require('path')

, declare = require( 'simpledeclare' )

, hotCoreJsonRestStores = hotplate.require('hotCoreJsonRestStores')
, hotCoreMultiHome = hotplate.require('hotCoreMultiHome')

, jsonRestStores = require( 'jsonreststores' )

;

app = hotplate.app;

jsonRestStores.artificialDelay = 500;

exports.hotHooks = hooks = {}

hotplate.hotEvents.on( 'stores', 'bd', hotplate.cachable( function( done ){

  var stores = {};

  var MultiHomePermsMixin = hotCoreMultiHome.MultiHomeBasicPermissionsMixin;
  var PrivateUserDataMixin = hotCoreJsonRestStores.PrivateUserDataPermissionsMixin;

  hotCoreJsonRestStores.get( function( err, s ){
    if( err ){
      done( err );
    } else {

      // Mixin the extra hotplate-specific and driver-specific attributes  to
      // the generic Store/Schema
      var HotStore = s.HotStore;
      var HotSchema = s.HotSchema;

      stores.UsersInfo = declare( [ HotStore, MultiHomePermsMixin, PrivateUserDataMixin ], {
    
        schema: new HotSchema({
          email       :  { type: 'string', required: true, default: "youremail@example.com", notEmpty: true, sharedValidator: 'email', trim: 70, min: 4 },
          surname     :  { type: 'string', required: true, default: "Your surname", notEmpty: true, trim: 10 },
          name        :  { type: 'string', required: true, default: "Your name", notEmpty: true, trim: 50 },
        }),
        searchSchema: new HotSchema({
          email     : { type: 'string', trim: 70, min: 4 },
          surname   : { type: 'string' },
          name      : { type: 'string' },
        }),
    
        handlePut: true,
        handleGet: true,
    
        storeName:  'UsersInfo',
    
        publicURL: '/config/users/:userId',
        hotExpose: true,
        configStore: { userId: true },
      });
    

      stores.UsersHobbies = declare( [ HotStore, MultiHomePermsMixin, PrivateUserDataMixin ], {
    
        schema: new HotSchema({
          name          : { type: 'string', required: true, trim: 35 },
        }),
        searchSchema: new HotSchema({
          name          : { type: 'string'},
        }),
    
        storeName: 'UsersHobbies',
    
        publicURL: '/config/users/:userId/hobbies/:id',
        hotExpose: true,
        configStore: { userId: true },

        positionField: 'position', 

        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,
      });


      stores.WorkspacesInfo = declare( [ HotStore, MultiHomePermsMixin ], {
    
        schema: new HotSchema({
          longName    : { type: 'string', required: true, default: "Workspace's long name", notEmpty: true, trim: 35 },
          tag         : { type: 'string', required: true, default: "Workspace's tag line",  notEmpty: true, notEmpty: true, trim: 70 },
        }),
    
        searchSchema: new HotSchema({
          longName    : { type: 'string' },
          tag         : { type: 'string' },
        }),
    
        storeName:  'WorkspacesInfo',
    
        publicURL: '/config/workspacesInfo/:workspaceId',
        hotExpose: true,
        configStore: { workspaceId: true },

        handlePut: true,
        handleGet: true,
      });
    
    
      stores.WorkspacesUsersInfo = declare( [ HotStore, MultiHomePermsMixin, PrivateUserDataMixin ], {
    
        schema: new HotSchema({
          userCategory  :  { type: 'id', required: false, notEmpty: false },
          localEmail    : { type: 'string', required: true, default: 'youremail@example.com', notEmpty: true, sharedValidator: 'email', trim: 35 },
        }),
        searchSchema: new HotSchema({
          userCategory :  { type: 'id' },
          localEmail   : { type: 'string'},
        }),
    
        storeName: 'WorkspacesUsersInfo',
    
        publicURL: '/config/workspaces/:workspaceId/users/:userId',
        hotExpose: true,
        configStore: { workspaceId: true, userId: true },

        handlePut: true,
        handleGet: true,
      });


      stores.WorkspacesUsersGoals = declare( [ HotStore, MultiHomePermsMixin, PrivateUserDataMixin ], {

        schema: new HotSchema({
          name        : { type: 'string', notEmpty: true, trim: 50 },
        }),
        searchSchema: new HotSchema({
          name        : { type: 'string', searchable: true, sortable: true, notEmpty: true, trim: 50 },
        }),
    
        storeName:  'WorkspacesUsersGoals',
          
        publicURL: '/config/workspaces/:workspaceId/users/:userId/Goals/:id',
        hotExpose: true,
        configStore: { workspaceId: true, userId: true },
  
        positionField: 'position', 
 
        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,
      });

      stores.WorkspacesUsersCategories = declare( [ HotStore, MultiHomePermsMixin ], {

        schema: new HotSchema({
          name        : { type: 'string', notEmpty: true, trim: 50 },
        }),
        searchSchema: new HotSchema({
          name       : { type: 'string', searchable: true, sortable: true, notEmpty: true, trim: 50 },
        }),
    
        storeName:  'WorkspacesUsersCategories',
          
        publicURL: '/config/workspaces/:workspaceId/usersCategories/:id',
        hotExpose: true,
        configStore: { workspaceId: true },
  
        positionField: 'position', 
 
        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,
      });

    
      stores.WorkspacesContactsCategories = declare( [ HotStore, MultiHomePermsMixin ], {

        schema: new HotSchema({
          name         : { type: 'string', notEmpty: true, trim: 50 },
        }),
    
        searchSchema: new HotSchema({
          name       : { type: 'string', sortable: true },
        }),
    
        storeName:  'WorkspacesContactsCategories',
          
        publicURL: '/config/workspaces/:workspaceId/contactsCategories/:id',
        hotExpose: true,
        configStore: { workspaceId: true },
  
        positionField: 'position', 

        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,
 
        checkPermissionsDeletee: function checkPermissionsGetQuery( params, body, options, doc, fullDoc, cb ){
          cb( null, false );
        },

      });

      // Root-level store
      stores.CompanySizes = declare( [ HotStore ], {

        schema: new HotSchema({
          name         : { type: 'string', notEmpty: true, trim: 50 },
        }),
    
        searchSchema: new HotSchema({
          name       : { type: 'string', searchable: true, sortable: true, notEmpty: true, trim: 50 },
        }),
    
        storeName:  'CompanySizes',
          
        publicURL: '/companySizes/:id',
        hotExpose: true,
        configStore: { },
  
        positionField: 'position', 

        hotGlobalBroadcast: true,

        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,
      });


      stores.WorkspacesContacts = declare( [ HotStore, MultiHomePermsMixin ],  {
    
        schema: new HotSchema({
          firstName         : { type: 'string', required: false, trim: 50 },
          middleName        : { type: 'string', required: false, trim: 50 },
          lastName          : { type: 'string', required: false, trim: 50 },
          dateOfBirth       : { type: 'date',   required: false },
          isCompany         : { type: 'boolean', trueWhen: 'on', required: false, trim: 64 },
        }),
    
        storeName:  'WorkspacesContacts',
          
        publicURL: '/workspaces/:workspaceId/Contacts/:id',
        hotExpose: true,

        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,
      });

      stores.WorkspacesContactsAddresses = declare( [ HotStore, MultiHomePermsMixin ],  {
    
        schema: new HotSchema({
          street            : { type: 'string', required: false, trim: 256 },
          poBox             : { type: 'string', required: false, trim: 64 },
          localArea         : { type: 'string', required: false, trim: 64 },
          city              : { type: 'string', required: false, trim: 64 },
          county            : { type: 'string', required: false, trim: 64 },
          postcode          : { type: 'string', required: false, trim: 10 },
          country           : { type: 'string', required: false, trim: 64 },
        }),
    
        storeName:  'WorkspacesContactsAddresses',
          
        publicURL: '/workspaces/:workspaceId/Contacts/:contactId/addresses/:id',
        hotExpose: true,

        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,
        positionField: 'position', 
      });

      stores.WorkspacesContactsEmails = declare( [ HotStore, MultiHomePermsMixin ],  {
    
        schema: new HotSchema({
          email             : { type: 'string', required: true, notEmpty: true, sharedValidator: 'email', trim: 70, min: 4 },
        }),
    
        storeName:  'WorkspacesContactsEmails',
          
        publicURL: '/workspaces/:workspaceId/contacts/:contactId/emails/:id',
        hotExpose: true,

        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,

        positionField: 'position', 

        // Don't allow the same email address twice
        postValidate: function( body, method, done ){
          var self = this;

          stores.WorkspacesContactsEmails.GetQuery( { filters: { email: body.email, contactId: body.contactId } }, function( err, docs ){
            if( err ) return done( err );

            // Filter self out (only need to do it for PUT calls)
            if( method === 'put' ){
              docs = docs.filter( function(i) { return i.id.toString() != body.id.toString() } );
            }
            

            if( docs.length ){          
              var errors = [];
              errors.push( { field: 'email', message: 'Email address already on file' } );
              done( new self.UnprocessableEntityError( { errors: errors } ) );
            } else {
              done( null );
            }
          });
        },

      });

/*
      stores.WorkspacesContactsEmailsThings = declare( [ HotStore, MultiHomePermsMixin ],  {

        schema: new HotSchema({
          thing             : { type: 'string', required: true, notEmpty: true, sharedValidator: 'email', trim: 70, min: 4 },
        }),
    
        storeName:  'WorkspacesContactsEmailsThings',
          
        publicURL: '/workspaces/:workspaceId/contacts/:contactId/emails/:emailId/things/:id',
        hotExpose: true,

        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,
      });
*/


      stores.Messages = declare( [ HotStore, MultiHomePermsMixin ],  {
    
        schema: new HotSchema({
          incoming          : { type: 'boolean', required: true, notEmpty: true },
          type              : { type: 'string', required: true, notEmpty: true, trim: 5 },
          fromUserId        : { type: 'id', required: false, notEmpty: true },
          fromContactId     : { type: 'id', required: false, notEmpty: true },

          subject           : { type: 'string', required: true, notEmpty: true, trim: 50 },
          body              : { type: 'string', required: true, notEmpty: true, trim: 50 },
        }),
    
        storeName:  'Messages',
          
        publicURL: '/workspaces/:workspaceId/Messages/:id',
        hotExpose: true,

        handlePut: true,
        handlePost: true,
        handleGet: true,
        handleGetQuery: true,
        handleDelete: true,
      });


    }
  }); 

  done( null, stores );

} ))


// Simply activate path to client files
hotplate.hotEvents.on( 'clientPath', 'bd', function( done ){
  done( null, path.join(__dirname, '../client') );
} )

// Define which paths within clientPath will need to be rendered, and with which options
hotplate.hotEvents.on( 'clientPathRender', 'bd', function( done ){
  done( null, [ 
    {
      'templates/BookingDojo.jade': { name: 'Tony' },
      'templates/AnotherBookingDojo.jade': {},
    }
  ] );
} )



hotplate.hotEvents.on( 'dojoModulesPerPage', 'bd', function( req, pageName, done ){

  switch( pageName ){

    case 'hotDojoAppContainer/container':
      done( null, [ 'bdMain' ] );
    break;

    default:
      done( null, [ ] );
    break;
  }

});


hotplate.hotEvents.on( 'pageElements', 'bd', function( done ){
    done( null, { titleWords: [ "Booking Dojo" ] } );
})

hotplate.hotEvents.on( 'pageElementsPerPage', 'bd', function( req, pageName, done ){

  switch(pageName){

    case 'hotDojoAppContainer/container':

      // Sending the page out
      done( null, {
        csses: ['bdMain.css' ],
        titleWords: [ "Application" ],
      });

    break;

   default:
      done( null, {} );
    break;
  }
});



