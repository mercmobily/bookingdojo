var 
  dummy

, hotplate =  require('hotplate')
, path = require('path')

, declare = require( 'simpledeclare' )

, Store = require('jsonreststores')
, MongoDriverMixin = require('jsonreststores/MongoDriverMixin.js')

, Schema = require('simpleschema')
, MongoSchemaMixin = require('simpleschema/MongoSchemaMixin.js')

, async = require('async')
, util = require('util')
, mongoWrapper = require('mongowrapper')
, db = hotplate.get('db')

, ObjectId = mongoWrapper.ObjectId
;

app = hotplate.app;

exports.hotHooks = hooks = {}

hooks.creatingUser = function( done, u, body ){

  var userConfig = {};
  userConfig.email = u.registerEmail;
  userConfig.name = body.name;
  userConfig.surname = body.surname;
  userConfig._id = u._id;

  var userConfigCollection = db.collection('userConfig');

  userConfigCollection.insert( userConfig, done );

}

hooks.creatingWorkspace = function( done, u, w ){

  
  var accessConfig = {};

  accessConfig._id = u._id;
  accessConfig.workspaceId = w._id;
  accessConfig.localEmail = u.registerEmail;
  // ...

  db.collection('accessConfig').insert( accessConfig, function( err ){

    if( err ){
      done( err );
    } else {

      var workspaceConfig = {};
      workspaceConfig.tag = "Your tagline here";
      workspaceConfig.longName = "Your workspace's description here";
      workspaceConfig._id = w._id;

      db.collection('workspaceConfig').insert( workspaceConfig, done );
    }
  })
}


hooks.createWorkspaceAnonSchema = function( done, schema ){

  schema.structure.name    = { type: 'string', notEmpty: true, required: true, trim: 45 };
  schema.structure.surname = { type: 'string', notEmpty: true, required: true, trim: 60 };

  done( null );
}

hooks.init = function( done ){
  done( null );
}

hooks.run = function( done ){

  var resUtils = hotplate.getModule('hotCoreResUtils');
  var messages = hotplate.getModule('hotMongoCometMessages');
  var sharedCode = hotplate.getModule('hotCoreSharedCode');
  var hotCoreJsonRestStores = hotplate.getModule('hotCoreJsonRestStores');

  // Add the db property to the mixin
  hotCoreJsonRestStores.StoreMixin.db = db;

  // Mixin the extra hotplate-specific and driver-specific attributes  to
  // the generic Store/Schema
  HotStore = declare.mixin( Store, [ MongoDriverMixin, hotCoreJsonRestStores.StoreMixin ] );
  HotSchema = declare.mixin( Schema, [ MongoSchemaMixin, hotCoreJsonRestStores.SchemaMixin ] );

  var Categories = declare( HotStore, {
    // COMMON
    schema: new HotSchema({
      workspaceId: { type: 'id' },
      _id     : { type: 'string', required: true, searchable: true },
      name    : { type: 'string', notEmpty: true, trim: 50 },
    }),

    // COMMON
    searchSchema: new HotSchema({
      workspaceId: { type: 'id' },
      _id        : { type: 'string', required: true },
      name       : { type: 'string', searchPartial: true, sortable: true, notEmpty: true, trim: 50 },
    }),

    makeId: function( object, done ){
      done( null, object.name + "_KEY" );
    },

    handlePut: true,
    handlePost: true,
    handleGet: true,
    handleGetQuery: true,
    handleDelete: true,

    storeName:  'categories',
    paramIds: [ 'workspaceId', '_id' ],
    // queryFilterType: '$or',
    // cometGroup: ['one', 'two', 'three' ],
  });

  Categories.onlineAll( app, '/call/:workspaceId/Categories/', ':_id' );


  console.log("TESTING THE APPPPPPPPPPPPPPPPPPIIIIIIIIIIIIIIIIIIIIIIIIIIIIII");
  //Categories.Post( { workspaceId: ObjectId() }, { name: "AHooooooooooAHAHAH" }, function( res, err ){
  //Categories.Post( { workspaceId: ObjectId() }, { name: "RAHooooooooooAHAHAH" }, function( res, err ){
  Categories.Post( { workspaceId: ObjectId(),  name: "RAHooooooooooAHAHAH4" }, function( res, err ){
    console.log("AAAAAAAAAAAHHHHHHHHHHHHHHH!");
    console.log( res );
    console.log( err );
  });

  /* ****************************************************************** */
  /* ****************************************************************** */
  /* ****************************************************************** */

  var UserConfigBase = declare( HotStore, {

    // COMMON
    schema: new HotSchema({
      _id    : { type: 'id' },

      email      : { type: 'string', notEmpty: true, sharedValidator: 'email', trim: 70, min: 4 },
      surname    : { type: 'string', notEmpty: true, trim: 10 },
      name       : { type: 'string', notEmpty: true, trim: 50 },
    },
    {
      validate: function( schema, errors, cb ){
        if( this.name == 'Tony' ){
          // cb( new Error("NO, TONY NO!" ) );
          errors.push( { field: 'name', message: 'NO! TONY NO!' } );
          cb( null );
        } else {
          cb( null );
        }
      },

    } ),

    paramIds :  [ '_id' ],
    collectionName: 'userConfig',

  });

  var UserConfig = declare( UserConfigBase, {

    handlePut: true,
    handleGet: true,

    storeName:  'userConfig',
    paramIds :  ['_id'],
    //paramIds:  [ 'workspaceId', '_id' ],
    //ignoreIds: [ 'workspaceId' ],

    // Permissions for the get
    checkPermissionsGet: function( params, body, options, doc, fullDoc, cb ) {
      // cb( null, req.application.workspace.access.filter( function(o){ return o._id.toString() === doc._id.toString(); } ).length  );
      cb( null, true  );
    },
  
    // Permissions to save data
    checkPermissionsPutExisting: function( params, body, options, doc, fullDoc, cb ) {
      // TODO: implement this
      cb( null, true );
    },

    // Nobody cannnot create new records -- they need to exist beforehand
    checkPermissionsPutNew: function( params, body, options, cb){
      cb( null, false ); 
    },
  });

  UserConfig.onlineAll( app, '/call/userConfig/', ':_id' );
 

  /*
  var UserConfigNoWorkspace = declare( UserConfigBase, {

    paramIds: [ '_id' ],

    // Redefine the permission calls 
    checkPermissionsGet: function(  params, body, options, doc, fullDoc, cb ){
      // cb( null,  req.session.userId.toString() == req.params._id );
      cb( null, true );
    },
    checkPermissionsPutExisting: function( req, doc, fullDoc, cb ) {
      // cb( null, req.session.userId.toString() == doc._id.toString() );
      cb( null, true );
    },

    storeName:  'userConfigNoWorkspace',

    killComet: true,
  });

  UserConfigNoWorkspace.onlineAll( app, '/call/userConfigNoWorkspace/', ':_id', UserConfigNoWorkspace );
  */  


  var WorkspaceConfig = declare( HotStore, {

    schema: new HotSchema({
      _id : { type: 'id' },

      longName: { type: 'string', notEmpty: true, trim: 35 },
      tag     : { type: 'string', notEmpty: true, notEmpty: true, trim: 70 },
    }),
    storeName:  'workspaceConfig',
    paramIds: [ '_id' ],

    handlePut: true,
    handleGet: true,

    checkPermissionsGet: function(  params, body, options, doc, fullDoc, cb ){
      cb( null, true );
      // cb( null, resUtils.currentUserInWorkspaceAccess( req, fullDoc ) );
    },

    checkPermissionsPutExisting: function( params, body, options, doc, fullDoc, cb ) {
      cb( null, true );
      // cb( null, resUtils.currentUserInWorkspaceAccess( req, fullDoc ) );
    },

    // Nobody cannnot create new records -- they need to exist beforehand
    checkPermissionsPutNew: function( params, body, options, cb){
      cb( null, false );
    },

  });

  WorkspaceConfig.onlineAll( app, '/call/workspaceConfig/', ':_id' );

  

  var AccessConfig = declare( HotStore, {

    // COMMON

    schema: new HotSchema({
      _id        : { type: 'id' },
      workspaceId   : { type: 'id' },

      localEmail : { type: 'string', notEmpty: true, trim: 35 },
    }),

    storeName: 'accessConfig',
    paramIds: [ 'workspaceId', '_id' ],

    handlePut: true,
    handleGet: true,

    // checkPermissionsGet:function( req, doc, fullDoc, cb ) {
    //   cb( null, true );
    // },

    // checkPermissionsPutExisting:function( req, doc, fullDoc, cb ) {
    //   cb( null, req.application.user._id.toString() == doc._id.toString() );
    // },

  } );

  AccessConfig.onlineAll( app, '/call/:workspaceId/accessConfig/', ':_id' );

  done( null );
}


hooks.pageElementsPerPage = function( done, elements, req, pageName ){


  switch(pageName){


    case 'hotDojoAppContainer/container':

      var userConfig, accessConfig, workspaceConfig;

      db.collection('userConfig').findOne( { _id: req.application.user._id }, function( err, doc ){

        if( err ) {
          done( err );
        } else {
          userConfig = doc;

          db.collection('workspaceConfig').findOne( { _id: req.application.workspace._id }, function( err, doc ){
            if( err ) {
              done( err );
            } else {
              workspaceConfig = doc;    

              db.collection('accessConfig').findOne( { _id: req.application.user._id, workspaceId: req.application.workspace._id }, function( err, doc ){
                if( err ) {
                  done( err );
                } else {

                  accessConfig        = doc;

                  // Sending the page out
                  done( null, {
                    moduleName: 'bd', result: {
                      jses:  ['bdMain.js', 'jade.js' ],
                      csses: ['bdMain.css' ],
                      vars: [
                        { name: 'userConfig',      value: userConfig },
                        { name: 'accessConfig',    value: accessConfig },
                        { name: 'workspaceConfig', value: workspaceConfig } 
                      ], 
                    }
                  });
                }
              })

            };
          })
        }


      });
      
   break;

    // Add an extra div to the "No workspaces to pick!" page, so that
    // a user can click on their config if they like (they are logged in after all)
    case 'hotDojoAuth/pickButEmptyPage':

      done( null, {
               moduleName: 'bd', result: {
                 body: elements.body.replace('</div></body>', '<div id="userConfig"></div></div></body>'),
                 jses: ['mainPickEnrich.js', 'jade.js'],
              }
      });
    break;

    case 'hotDojoAuth/registerPage':
      done( null, {
               moduleName: 'bd', result: {
                 jses: ['mainChangeRegisterForm.js'],
              }
      });
    break;

    default:
      done( null, { moduleName: 'bd', result: {} }  );
    break;
  }
}


// Simply activate path to client files
hooks.clientPaths = function( done ){
  done( null, { moduleName: 'bd', result: [ path.join(__dirname, '../client') ] } );
}


hooks.stores = function( done ){
  done( null, { 
    accessConfig         : { target: '/call/:workspaceId/accessConfig/',    idProperty: '_id', sortParam: 'sortBy', },
    workspaceConfig      : { target: '/call/workspaceConfig/', idProperty: '_id', sortParam: 'sortBy', },
    userConfig           : { target: '/call/userConfig/',      idProperty: '_id', sortParam: 'sortBy', },
    categories           : { target: '/call/:workspaceId/Categories/',      idProperty: '_id', sortParam: 'sortBy', },
    // options              : { target: '/call/:workspaceId/Options/',         idProperty: '_id', sortParam: 'sortBy', },
  });
}


hooks.sharedFunctions = function( done ) {
  var result = {};
  done( null, { moduleName: 'bd', result: result } );
}



