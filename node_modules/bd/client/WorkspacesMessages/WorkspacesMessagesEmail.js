define([
  "dojo/_base/declare"

, "dojo/on"
, "dijit/form/ValidationTextBox"
, "dijit/Editor"

, "hotplate/bd/WorkspacesMessages/WorkspacesContactsToEmail"
, "hotplate/hotDojoWidgets/widgets"
, "hotplate/hotDojoWidgets/EditingWidget"
, "hotplate/hotDojoWidgets/BusyButton"

], function(
  declare

, on
, ValidationTextBox
, Editor

, WorkspacesContactsCcEmail
, widgets
, EditingWidget
, BusyButton

){
  return  declare([ EditingWidget ], {

    templateString: '' +
      '<div class="workspaces-messages-email">\n' +
      '  <form data-dojo-type="dijit/form/Form" data-dojo-attach-point="formWidget" method="POST">\n' +

      '    <div id="${id}_to" name="to" data-dojo-attach-point="to" data-dojo-type="hotplate/bd/WorkspacesMessages/WorkspacesContactsToEmail" data-dojo-props="defaultTo: this.contactObject"></div>\n' +

      '    <input id="${id}_subject" class="workspaces-messages-email-subject" name="subject" data-dojo-type="dijit/form/ValidationTextBox" maxlength="128" data-dojo-props="placeHolder:\'Subject\', required:true" data-dojo-attach-point="subjectWidget" />\n' +

      '    <div id="${id}_body" class="workspaces-messages-email-body" name="body" data-dojo-attach-point="bodyWidgetNode"></div>\n' +

      '    <input class="form-submit" type="submit" data-dojo-attach-point="buttonWidget" data-dojo-type="hotplate/hotDojoWidgets/BusyButton" label="Send" />' +
      '  </form>\n'+
      '</div>\n'+
      '',
    alertBarDomPlacement: 'first',
    resetOnSuccess: true, 

    // The editor will only ever work if it's created on a visible TAB
    _onShow: function(){
      this.inherited(arguments);

      if( ! this.editorInitialised ){

        this.bodyWidget = new Editor({ name: 'body', height:'150px' }, this.bodyWidgetNode );
        this.bodyWidget.startup();
        this.editorInitialised = true;
      }
    },

    postCreate: function(){
      this.inherited(arguments);
      var self = this;

      // Editor doesn't implement reset, have to reset it by hand... ugh!
      this.on( 'successfulsubmit', function(){
        self.bodyWidget.set('value', '');
        self.to.resetTo();
      });

    },

    manipulateValuesBeforeSubmit: function( values ){

      var self = this;

      values.type = 'email';

      // Create the list of email IDs to be submitted -- comma separated
      values.to = '';
      var a = [];
      var keys = Object.keys( self.to._alreadyAddedHash );
      for( var i = 0, l = keys.length; i < l; i ++ ){
        a.push( keys[ i ] );
      }
      values.to = a.join( ',' );
    },

    savedMessage: 'Email queued!',

  });
});