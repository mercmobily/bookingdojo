/*
INPUT: 
  * workspaceId
  * messageId
DESCRIPTION
A widget used to show AND manipulate the `from` field of a message depending on the message being incoming or not.
For outgoing messages, the `from` field won't be modifiable and will just get displayed.
For incoming messages, the `from` will offer a menu to 1) Link to a new contact 2) Link to an existing contact, 3) Link to another contact matching the same email address. This is because working which contactId a message is from can be tricky (especially since two contacts can have the same SMS or email), and the widget needs to provide a way to set which contactId the message was actually from.
*/
define([

  "dojo/_base/declare"

, "dijit/form/Form"
, "dijit/form/Select"

, "hotplate/hotClientDojo/widgets/ViewingWidget"
, "hotplate/hotClientDojo/widgets/Dummy"
, "hotplate/hotClientDojo/widgets/util"

, "hotplate/bd/formatters"

], function(

  declare

, Form
, Select

, ViewingWidget
, Dummy
, util

, formatters

){

  return declare( [ ViewingWidget ], {

    templateString: '' +
    '<div class="contact-from-select">\n' +
    '    <div data-dojo-attach-point="selectNode"></div>\n' +
    '</div>\n' +
    '',
  
    postMixInProperties: function(){
      this.inherited(arguments);

      this.info = {
        workspacesMessages: {
          id: this.workspaceMessage.id,
          data: this.workspaceMessage,
          storeParameters: { workspaceId: this.workspaceMessage.workspaceId },
        },
      }
    },    
    
    _populateSelectWidget: function(){

      var self = this;

      var data = self.info.workspacesMessages.data;
      var options = [];

      if( data.fromContactId ){
        options.push({
          label: formatters.contactName( data._children.fromContactId ),
          value: "contact",
        });
      } else {
        options.push({
          label: util.escapeHTML( self.info.workspacesMessages.data._children.messageId.from ),
          value: "selection"
        });
      }

      options = options.concat([
        { label: "Link to a new contact",
          value: "new"
        },
        { 
          label: "Link to another existing contact",
          value: "existing"
        }
      ]);

      if( data.fromContactId ){
        options.push({
          label: "Look for more matching contacts",
          value: "more"
        });
      };

      this.selectWidget.set( 'options', options );
      this.selectWidget.set( 'value', this.selectWidget.value );

      // Add people with matching email addresses as options, with parseable IDs
    },

    renderInfo: function(){
      this.inherited(arguments);

      var self = this;
      var data = self.info.workspacesMessages.data;

      var options = [];

      // OUTGOING message: it's _certainly_ from a fromContactId, and it's not
      // changeable
      if( !data.incoming ){
        this.selectNode.innerHTML = formatters.contactName( data._children.fromContactId );

      // INGOING: it's from the outside, the system tried to match which contact it
      // was from, but it's error prone. Offer a select to change the contactId
      } else {

        if( this.selectWidget ){
          this.selectWidget.destroy();
        }
      
        this.selectWidget = new Select({
          name: 'operation',
          options: {},
        }, this.selectNode );
        
        this._populateSelectWidget();

        self.selectWidget.on('change', function( e ){
          var newValue = self.selectWidget.get('value');

          switch( newValue ){
            case 'existing':
              self.selectWidget.set('value', 'contact' );
            break;

            case 'new':

            break;

            case 'more':
            
            break;

          }



        })



      }
    },

    postCreate: function(){
      this.inherited(arguments);


    }


  });

});
