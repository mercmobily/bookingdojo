/*
INPUT:
* workspaceId
* contactId
DESCRIPTION
An editing widget to edit a specific contactId's basic information (`workspacesContacts`).
*/

define([

  "dojo/_base/declare"

, "dijit/form/Form"
, "dijit/form/ValidationTextBox"
, "dijit/form/DateTextBox"
, "dijit/form/CheckBox"
, "dojo/dom-style"

, "hotplate/hotClientDojo/widgets/BusyButton"
, "hotplate/hotClientDojo/widgets/EditingWidget"
, "hotplate/hotClientDojo/widgets/UTCDateTextBox"

, "hotplate/bd/WorkspacesContacts/WorkspacesContactsCategoriesSelect"

], function(

  declare

, Form
, ValidationTextBox
, DateTextBox
, CheckBox
, domStyle

, BusyButton
, EditingWidget
, UTCDateTextBox
, WorkspacesContactsCategoriesSelect

){

  return declare( [ EditingWidget ], {

    storeName: 'workspacesContacts',

    _showPersonalFields: true,

    templateString: '' +
      '<div class="workspaces-contacts-info">\n' +
      '  <div class="box">\n'+
      '    <p class="boxTitle">Details</p>\n' +

      '    <form data-dojo-type="dijit/form/Form" data-dojo-attach-point="formWidget" method="POST">\n' +

      '      <div class="inputField is-company">\n' +
      '        <label for="${id}_isCompany">Company?</label>\n' +
      '        <input id="${id}_isCompany" name="isCompany" data-dojo-type="dijit/form/CheckBox" data-dojo-attach-point="isCompanyWidget" data-dojo-props: "" value="on" tabindex="10" />\n' +
      '      </div>\n' +

      '      <div class="inputField name">\n' +
      '        <label for="${id}_firstName">Name</label>\n' +
      '        <input id="${id}_firstName" name="firstName" data-dojo-type="dijit/form/ValidationTextBox" data-dojo-attach-point="firstNameWidget" size="25" maxlength="50" tabindex="1"/>\n' +
      '      </div>\n' +

      '      <div class="inputField middle-name" data-dojo-attach-point="middleNameField">\n' +
      '        <label for="${id}_middleName">Middle Name</label>\n' +
      '        <input id="${id}_middleName" name="middleName" data-dojo-type="dijit/form/ValidationTextBox" data-dojo-attach-point="middleNameWidget" size="10" maxlength="50" tabindex="2" />\n' +
      '      </div>\n' +

      '      <div class="inputField last-name" data-dojo-attach-point="lastNameField">\n' +
      '        <label for="${id}_lastName">Last Name</label>\n' +
      '        <input id="${id}_lastName" name="lastName" data-dojo-type="dijit/form/ValidationTextBox" data-dojo-attach-point="lastNameWidget" size="10" maxlength="50" tabindex="3" />\n' +
      '      </div>\n' +

      '      <div class="inputField date-of-birth" data-dojo-attach-point="dateOfBirthField">\n' +
      '        <label for="${id}_dateOfBirth">Date Of Birth</label>\n' +
      '        <input class="input" id="${id}_dateOfBirth" name="dateOfBirth" data-dojo-type="hotplate/hotClientDojo/widgets/UTCDateTextBox" data-dojo-attach-point="dateOfBirthWidget" tabindex="4" />\n' +
      '      </div>\n' +

      '      <div class="inputField contact-category" data-dojo-attach-point="contactCategory">\n' +
      '        <label for="${id}_contactCategory">Contact type</label>\n' +
      '        <div id="${id}_contactCategory" name="contactCategory" data-dojo-type="hotplate/bd/WorkspacesContacts/WorkspacesContactsCategoriesSelect" data-dojo-props="workspaceId: this.workspaceId, initialFilter: { enabled: true }"></div>\n'+
      '      </div>\n' +

      '      <input class="formSubmit" type="submit" data-dojo-attach-point="buttonWidget" data-dojo-type="hotplate/hotClientDojo/widgets/BusyButton" label="Save" tabindex="5" />\n' +


      '    </form>\n' +
      '  </div>\n'+
      '</div>\n'+
      '',

      postMixInProperties: function(){
        this.inherited(arguments);

        this.storeParameters = { workspaceId: this.workspaceId };        
        this.recordId = this.contactId;
      },

      // Makes sure that data makes sense:
      // * isCompany is sent as a boolean flag
      // * company-type fields are deleted if they are not shown
      // * Date of birth is deleted if null
      // * contactCategory is deleted if there is a linked used Id or if it's 
      //   a new record
      manipulateValuesBeforeSubmit: function( values ){
        values.isCompany = values.isCompany.indexOf( 'on' ) !== -1;

        if( ! this._showPersonalFields ){
          delete values.dateOfBirth;
          delete values.lastName;
          delete values.middleName;
          delete values.contactCategory;
        }
        if( values.dateOfBirth === null ) delete values.dateOfBirth;
       
        // If it's a an existing record, and if it's a linked user, delete
        // the contactCategory field which doesn't make sense to users
        if( this.recordId && this.loadedInfo.userId ){
          delete values.contactCategory;
        }

      },

      // Sets the isCompany widget depending on value fetched
      afterFormWidgetSet: function( res ){

        // Sets the checkbox for isCompany according to what was fetched
        if( res.isCompany ) this.isCompanyWidget.set('value', true );

        // Sets whether contactCategory will display or not. It will ALSO set
        // this.contactCategoryFieldOriginalStyle, which is used to decide whether or not
        // the widget should be shown in general
        if( this.recordId && this.loadedInfo.userId ){
          domStyle.set( this.contactCategory, 'display', 'none' );
        } else {
          domStyle.set( this.contactCategory, 'display', 'block' );
        }
        this.contactCategoryFieldOriginalStyle = domStyle.get( this.contactCategory, 'display' );


      },

      // Will hide personal info if needed
      _togglePersonalInfo: function( hide ){

        if( hide ){
          domStyle.set( this.dateOfBirthField, 'display', 'none' );
          domStyle.set( this.lastNameField, 'display', 'none' );
          domStyle.set( this.middleNameField, 'display', 'none' );
          domStyle.set( this.contactCategory, 'display', 'none' );   
          this._showPersonalFields = false;
        } else {
          domStyle.set( this.dateOfBirthField, 'display', this.dateOfBirthFieldOriginalStyle );
          domStyle.set( this.lastNameField, 'display', this.lastNameFieldOriginalStyle );
          domStyle.set( this.middleNameField, 'display', this.middleNameFieldOriginalStyle );
          domStyle.set( this.contactCategory, 'display', this.contactCategoryFieldOriginalStyle );

          this._showPersonalFields = true;
        }
        
      },

      postCreate: function(){
        this.inherited( arguments );

        var self = this;

        // Set the default value for popup to sometime in the past if it's a new record
        if( ! self.recordId || ! self.dateOfBirthWidget.get('value') ){
          self.dateOfBirthWidget.set( 'dropDownDefaultValue', new Date('1/1/1976') );
        }

        // Get original styles for the widgets that will need to disappear (they might be
        // "block" or "inline-block" or "inline" etc.)
        self.dateOfBirthFieldOriginalStyle = domStyle.get( this.dateOfBirthField, 'display' );
        self.lastNameFieldOriginalStyle = domStyle.get( this.lastNameField, 'display' );
        self.middleNameFieldOriginalStyle = domStyle.get( this.middleNameField, 'display' );
        
        // If it's an existing record, determine whether to show extra fields
        if( self.recordId ){
          self._togglePersonalInfo( self.isCompanyWidget.get('value') );
        }

        // Changing the checkbox (if it's a company) will affect the form
        self.isCompanyWidget.on( 'change', function( status ){
          self._togglePersonalInfo( status );
        });


      },

  });
});


