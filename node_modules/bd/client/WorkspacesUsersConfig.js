
define([
  "dojo/_base/declare"
, "dojo/topic"

, "dijit/layout/ContentPane"

, "hotplate/hotDojoWidgets/widgets"

, "hotplate/hotDojoGlobals/globals"
, "hotplate/hotDojoStores/stores"


, "hotplate/bd/WorkspacesUsersConfig/WorkspacesUsersInfo"
, "hotplate/bd/WorkspacesUsersConfig/WorkspacesUsersActivities"
, "hotplate/bd/WorkspacesContacts"

], function(
  declare
, topic

, ContentPane

, widgets

, globals
, stores

, WorkspacesUsersInfo
, WorkspacesUsersActivities
, WorkspacesContacts

){

  return declare( [ widgets.DestroyableTemplatedContainer ], {

    templateString: '' +
      '<div class="workspaces-users-config">\n' +
      '  <div class="box">\n'+
      '    <p class="boxTitle">Your contact information</p>\n' +
      '    <div id="workspaces-users-config-contact-editor" data-dojo-attach-point="contactEditorWidget"></div>\n' +
      '  </div>\n' +
      
      '  Your main address: <span data-dojo-attach-point="mainEmailAddressNode"></span>\n' +

      '  <div data-dojo-type="hotplate/bd/WorkspacesUsersConfig/WorkspacesUsersInfo"></div>\n' +


      '  <span class="config-heading">Activities you do for this workspace</span>\n' +
      '  <div class="small-editable-list" data-dojo-type="hotplate/bd/WorkspacesUsersConfig/WorkspacesUsersActivities"></div>\n'+
    
      '</div>\n' +
      '',

    postCreate: function(){
      this.inherited(arguments);

      var self = this;

      var myContactId = vars.hotCoreStoreConfig.storeRecords.workspacesUsersInfo._children.workspacesContacts[0].id;

      // Make a new WorkspaceContacts instance, and place it over self.contactEditorWidget
      new WorkspacesContacts({
        storeName: 'workspacesContacts',
        storeParameters: { workspaceId: globals.workspaceId },
        recordId: myContactId,
      }, self.contactEditorWidget);

      // Print the main email Id for myContact in self.mainEmailAddressNode, AND watch for
      // changes in case it gets updated.
      var workspacesContactsStore = stores('workspacesContacts', { workspaceId: globals.workspaceId } ) ;

      workspacesContactsStore.get( myContactId ).then( function( record ){
        self.mainEmailAddressNode.innerHTML = record._children.mainEmailId.email;
      });
      topic.subscribe( 'storeRecordUpdate', function( from, message, remote ){
        if( message.storeName == 'workspacesContacts' && message.objectId == myContactId ){
         self.mainEmailAddressNode.innerHTML = message.object._children.mainEmailId.email; 
        }
      });
    },

  });

});
