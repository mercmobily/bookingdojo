
define([
  "dojo/_base/declare"
, "dojo/aspect"

, "dijit/form/ValidationTextBox"
, "dijit/_WidgetBase"
, "dijit/Destroyable"

, "put-selector/put"

, "hotplate/hotDojoDgridWidgets/commonMixins"
, "hotplate/hotDojoWidgets/widgets"
, "hotplate/hotDojoWidgets/TempDialog"
, "hotplate/hotDojoWidgets/EditingWidget"
, "hotplate/hotDojoDgridWidgets/EditableList"
, "hotplate/hotDojoWidgets/BusyButton"
, "hotplate/hotDojoStores/stores"
, "hotplate/hotDojoWidgets/StoreToggle"
, "hotplate/hotDojoGlobals/globals"

, "hotplate/bd/WorkspacesContacts"

], function(
  declare
, aspect

, ValidationTextBox
, _WidgetBase
, Destroyable

, put

, commonMixins
, widgets
, TempDialog
, EditingWidget
, EditableList
, BusyButton
, stores
, StoreToggle
, globals

, WorkspacesContacts
){

  return declare( [ EditableList ], {

    refreshOnSubmit: true,
    immediateRefresh: false,

    ListConstructor: declare( [ commonMixins.FullOnDemandList ], {

      renderRow: function(object, options){
      
        var self = this;
 
        var firstName, lastName, middleName;

        // Get the DOM variables ready
        if( object.firstName ) firstName = put( 'span.lastName',    object.firstName );
        if( object.lastName )  lastName =  put( 'span.firstName',   object.lastName );
        if( object.middleName) middleName = put( 'span.middleName', object.middleName );
        var star = new StoreToggle({ 

          toggleField: 'isStarred',
          storeName: 'WorkspacesContactsIsStarred',
          storeParameters: {
            workspaceId: globals.workspaceId,
          },
          recordId: object.id,

          ticked: object._ref.isStarred,
        } );
       
        // Make up the row
        var row = put( 'div.row' );
        put( row, star.domNode );
        if( firstName ) put( row, firstName );
        if( middleName ) put( row, middleName );
        if( lastName ) put( row, lastName );

        row.starWidget = star;
        star.startup();
      
        return row;
      },
      queryOptions: { placeNew: 'last' },
      dndParams: { selfAccept: false },

      postCreate: function(){
        this.inherited(arguments);
        var self = this;

        // Destroy the widgets contained in the row before killing the row itself
        aspect.before( self, "removeRow", function( rowElement ){
          rowElement.starWidget.destroy();
        });                
 
      },

    }),

    EditingConstructor: WorkspacesContacts,

    ExtraWidgetConstructor: declare( [ widgets.DestroyableTemplatedContainer ], {
      templateString: '' +
        '<div>\n' +
        '  <div data-dojo-attach-point="buttonWidget" data-dojo-type="hotplate/hotDojoWidgets/BusyButton" label="New" />\n' +
        '</div>\n'+
        '',
    }),
    extraWidgetRegion: 'top',

    storeName: 'WorkspacesContacts',
    storeParameters: { workspaceId: globals.workspaceId },
    editingWidgetPlacement: 'dialog',
    multipleEditingAllowed: false,
    gutters: false,

    buttonsPosition: 'after', // or "top" or "bottom"
    buttonsLeftOffset: 25,

    postCreate: function(){

      this.inherited(arguments);
      var self = this;

      self.extraWidget.buttonWidget.on( 'click', function( e ){
        self.addingConstructorInDialog( 'New contact' );
      });

   },


  } );

});


